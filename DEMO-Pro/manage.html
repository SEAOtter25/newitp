<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITOPPLUS - Manage Assets</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ... (โค้ด CSS ของคุณทั้งหมดเหมือนเดิม) ... */
        :root {
            --company-green-light: #e8f5e9;
            --company-green-main: #66bb6a;
            --company-green-dark: #4caf50;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --app-bg-light: #f4f7f6;
            --card-bg: #ffffff;
            --panel-bg-dark: #2c3e50;
            --panel-text-light: #ecf0f1;
            --panel-active-bg: rgba(102, 187, 106, 0.15);
            --panel-active-color: var(--company-green-main);
            --shadow-subtle: 0 6px 20px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 25px rgba(0, 0, 0, 0.1);
            --color-blue: #3498db;
            --color-orange: #f39c12;
            --color-red: #e74c3c;
            --border-radius-lg: 16px;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            background-color: var(--app-bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .page-wrapper {
            display: flex;
            width: 100%;
            min-height: 100vh;
            position: relative;
        }

        .left-panel {
            width: 280px;
            min-width: 280px;
            background-color: var(--panel-bg-dark);
            color: var(--panel-text-light);
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            box-shadow: var(--shadow-subtle);
            z-index: 20;
            border-radius: 0 var(--border-radius-lg) var(--border-radius-lg) 0;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
        }

        .panel-logo {
            height: 45px;
            width: auto;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.1));
        }

        .panel-title {
            font-size: 2.0rem;
            font-weight: 700;
            color: #fff;
            letter-spacing: 1px;
        }

        .panel-nav {
            flex-grow: 1;
        }

        .panel-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .panel-nav li {
            margin-bottom: 6px;
        }

        .panel-nav a {
            display: flex;
            align-items: center;
            color: var(--panel-text-light);
            text-decoration: none;
            padding: 14px 15px;
            border-radius: var(--border-radius-sm);
            font-size: 1.05rem;
            transition: background 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }

        .panel-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--panel-active-color);
            transform: translateX(8px);
        }

        .panel-nav a.active {
            background: var(--panel-active-bg);
            color: var(--panel-active-color);
            font-weight: 600;
            transform: translateX(5px);
        }

        .panel-nav a i {
            margin-right: 18px;
            font-size: 1.35rem;
            width: 25px;
            text-align: center;
        }

        .panel-quick-stats {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding-left: 10px;
        }

        .panel-quick-stats h4 {
            color: #fff;
            font-size: 1.15rem;
            margin-bottom: 15px;
            opacity: 0.95;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-item i {
            font-size: 2rem;
            color: var(--company-green-main);
            width: 35px;
            text-align: center;
        }

        .stat-item .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #fff;
            line-height: 1;
        }

        .stat-item .stat-label {
            font-size: 0.9rem;
            color: var(--panel-text-light);
        }

        .panel-footer {
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding-left: 10px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--panel-text-light);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .user-profile .user-avatar {
            font-size: 2.2rem;
            color: var(--company-green-main);
        }

        .logout-btn {
            background-color: var(--company-green-main);
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius-md);
            font-size: 1.05rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .logout-btn:hover {
            background-color: var(--company-green-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .logout-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .main-content-area {
            flex-grow: 1;
            padding: 40px;
            background-color: var(--app-bg-light);
            position: relative;
            border-radius: var(--border-radius-lg) 0 0 var(--border-radius-lg);
            margin-left: -20px;
            z-index: 10;
        }

        .main-content-header {
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 20px;
        }

        .main-content-header h1 {
            font-size: 3.2rem;
            font-weight: 800;
            color: var(--text-dark);
            margin: 0;
            letter-spacing: -0.5px;
        }

        .main-content-header .user-display-top {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 1rem;
            opacity: 0.9;
            background-color: var(--card-bg);
            padding: 8px 15px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-subtle);
        }

        .main-content-header .user-display-top i {
            font-size: 1.6rem;
            color: var(--company-green-main);
        }

        .main-content-header .user-display-top span {
            color: var(--text-dark);
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-subtle);
            padding: 30px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.4s ease, transform 0.4s ease;
            opacity: 0;
            transform: translateY(30px);
            position: relative;
        }

        .card.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
        }

        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 180px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .filter-group input[type="text"],
        .filter-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dfe6e9;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            color: var(--text-dark);
            background-color: #f9fbfa;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .filter-group input[type="text"]:focus,
        .filter-group select:focus {
            border-color: var(--company-green-main);
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.2);
            outline: none;
        }

        .filter-buttons {
            display: flex;
            gap: 15px;
            flex-shrink: 0;
        }

        .filter-btn,
        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .filter-btn.primary {
            background-color: var(--company-green-main);
            color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .filter-btn.primary:hover {
            background-color: var(--company-green-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .filter-btn.secondary {
            background-color: #ecf0f1;
            color: var(--text-dark);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .filter-btn.secondary:hover {
            background-color: #dfe6e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }


        .asset-table-container {
            overflow-x: auto;
            margin-top: 30px;
            box-shadow: var(--shadow-subtle);
            border-radius: var(--border-radius-lg);
            background: var(--card-bg);
            padding: 25px;
        }

        .asset-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            white-space: nowrap;
        }

        .asset-table thead th {
            padding: 15px 20px;
            background-color: var(--company-green-light);
            color: var(--company-green-dark);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--company-green-main);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .asset-table thead tr:first-child th:first-child {
            border-top-left-radius: var(--border-radius-sm);
        }

        .asset-table thead tr:first-child th:last-child {
            border-top-right-radius: var(--border-radius-sm);
        }

        .asset-table tbody td {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e6e9;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .asset-table tbody tr:last-child td {
            border-bottom: none;
        }

        .asset-table tbody tr:hover {
            background-color: #f0f7f5;
        }

        .action-column {
            text-align: center;
        }

        .action-column .action-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
            margin: 0 5px;
        }

        .action-btn.edit {
            background-color: var(--color-blue);
            color: #fff;
        }

        .action-btn.edit:hover {
            background-color: #2980b9;
        }

        .action-btn.delete {
            background-color: var(--color-red);
            color: #fff;
        }

        .action-btn.delete:hover {
            background-color: #c0392b;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }

        .pagination button {
            background-color: var(--card-bg);
            border: 1px solid #dfe6e9;
            border-radius: var(--border-radius-sm);
            padding: 10px 15px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-dark);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .pagination button:hover:not(:disabled) {
            background-color: var(--company-green-light);
            border-color: var(--company-green-main);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            font-weight: 600;
            color: var(--text-dark);
        }

        @media (max-width: 1024px) {
            .left-panel {
                width: 250px;
                min-width: 250px;
                padding: 25px 15px;
            }

            .panel-nav a {
                font-size: 1rem;
            }

            .panel-nav a i {
                font-size: 1.15rem;
            }

            .main-content-area {
                padding: 30px;
                margin-left: -15px;
            }

            .main-content-header h1 {
                font-size: 2.8rem;
            }

            .main-content-header .user-display-top {
                font-size: 0.95rem;
            }

            .main-content-header .user-display-top i {
                font-size: 1.4rem;
            }

            .card {
                padding: 25px;
            }

            .filter-group {
                min-width: 150px;
            }

            .filter-btn,
            .action-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .asset-table thead th,
            .asset-table tbody td {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 768px) {
            .left-panel {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease-out;
                border-radius: 0;
            }

            .left-panel.active {
                transform: translateX(0%);
            }

            .main-content-area {
                margin-left: 0;
                padding: 20px;
                border-radius: 0;
            }

            .mobile-menu-toggle {
                display: flex;
                top: 20px;
                left: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .main-content-header {
                text-align: left;
                margin-top: 70px;
                margin-bottom: 25px;
                flex-direction: column;
                align-items: flex-start;
                padding-right: 0;
            }

            .main-content-header h1 {
                font-size: 2.4rem;
            }

            .main-content-header .user-display-top {
                margin-top: 15px;
                align-self: stretch;
                justify-content: center;
                padding: 10px;
            }

            .filter-section {
                flex-direction: column;
                gap: 15px;
            }

            .filter-group {
                width: 100%;
                min-width: unset;
            }

            .filter-buttons {
                flex-direction: column;
                width: 100%;
            }

            .filter-btn,
            .action-btn {
                width: 100%;
                justify-content: center;
            }

            .asset-table-container {
                padding: 15px;
            }

            .asset-table thead th,
            .asset-table tbody td {
                padding: 10px;
                font-size: 0.85rem;
            }
        }

        /* เพิ่ม CSS สำหรับ SweetAlert2 Popup Form */
        .swal2-container .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .swal2-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .swal2-container input[type="text"],
        .swal2-container input[type="date"],
        .swal2-container textarea,
        .swal2-container select {
            width: calc(100% - 20px);
            /* ลบ padding รวมกัน */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box;
            /* เพื่อให้ padding ไม่ขยาย width เกิน 100% */
        }

        .swal2-container textarea {
            resize: vertical;
            min-height: 80px;
        }
    </style>
</head>

<body>
    <div class="page-wrapper">
        <aside class="left-panel" id="leftPanel">
            <div class="panel-header">
                <span class="panel-title">ITOPPLUS</span>
            </div>

            <nav class="panel-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fa-solid fa-chart-line"></i> <span>Dashboard</span></a></li>
                    <li><a href="manage.html" class="active"><i class="fa-solid fa-boxes-stacked"></i>
                            <span>Assets</span></a></li>
                    <li><a href="assetowner.html"><i class="fa-solid fa-user-tag"></i> <span>Asset Owner</span></a></li>
                    <li><a href="insert.html"><i class="fa-solid fa-plus-circle"></i> <span>Insert to Asset</span></a>
                    </li>
                    <li><a href="note.html"><i class="fa-solid fa-note-sticky"></i> <span>Notes</span></a></li>
                    <li id="memberLinkWrapperLeftPanel"><a href="member.html"><i class="fa-solid fa-users"></i>
                            <span>Member</span></a></li>
                    <li id="historyLinkWrapperLeftPanel"><a href="history.html"><i class="fa-solid fa-history"></i>
                            <span>History</span></a></li>
                </ul>
            </nav>

            <div class="panel-quick-stats">
                <h4>Quick Stats</h4>
                <div class="stat-item">
                    <i class="fa-solid fa-arrow-up-right-dots"></i>
                    <div>
                        <span class="stat-value" id="assetsAddedMonth">0</span>
                        <span class="stat-label">Assets Added (Month)</span>
                    </div>
                </div>
                <div class="stat-item">
                    <i class="fa-solid fa-arrow-down-left-dots"></i>
                    <div>
                        <span class="stat-value" id="assetsRetiredMonth">0</span>
                        <span class="stat-label">Assets Retired (Month)</span>
                    </div>
                </div>
            </div>

            <div class="panel-footer">
                <div class="user-profile">
                    <i class="fa-solid fa-user-circle user-avatar"></i>
                    <span id="userNameDisplay">Guest User</span>
                </div>
                <button class="logout-btn" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
            </div>
        </aside>

        <main class="main-content-area">
            <header class="main-content-header">
                <h1>Manage Assets</h1>
                <div class="user-display-top">
                    <span>Guest User</span>
                    <i class="fa-solid fa-user-circle"></i>
                </div>
            </header>

            <div class="manage-assets-section card is-visible" data-delay="0">
                <h3>Asset Inventory</h3>

                <div class="filter-section">
                    <div class="filter-group">
                        <label for="searchAsset">Search by Code / SN:</label>
                        <input type="text" id="searchAsset" placeholder="Enter asset code or serial number">
                    </div>
                    <div class="filter-group">
                        <label for="filterType">Filter by Type:</label>
                        <select id="filterType">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterStatus">Filter by Status:</label>
                        <select id="filterStatus">
                            <option value="">All Statuses</option>
                            <option value="In Use">In Use</option>
                            <option value="In Repair">In Repair</option>
                            <option value="Ready">Ready</option>
                            <option value="Retired">Retired</option>
                            <option value="Broken">Broken</option>
                        </select>
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn primary" id="applyFiltersBtn"><i class="fa-solid fa-filter"></i> Apply
                            Filters</button>
                        <button class="filter-btn secondary" id="clearFiltersBtn"><i class="fa-solid fa-xmark"></i>
                            Clear Filters</button>
                    </div>
                </div>

                <div class="asset-table-container">
                    <table class="asset-table">
                        <thead>
                            <tr>
                                <th>Asset Code</th>
                                <th>Serial Number</th>
                                <th>Type</th>
                                <th>Brand</th>
                                <th>Model</th>
                                <th>Status</th>
                                <th>Owner</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assetTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูลสินทรัพย์...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    <button id="prevPageBtn" disabled><i class="fa-solid fa-chevron-left"></i> Previous</button>
                    <span id="currentPageDisplay">Page 1 of 1</span>
                    <button id="nextPageBtn" disabled>Next <i class="fa-solid fa-chevron-right"></i></button>
                </div>

            </div>
        </main>
    </div>

    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fa-solid fa-bars"></i>
    </button>

    <script>
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const leftPanel = document.getElementById('leftPanel');

        mobileMenuToggle.addEventListener('click', () => {
            leftPanel.classList.toggle('active');
        });

        document.addEventListener('click', (event) => {
            if (window.innerWidth <= 768 && !leftPanel.contains(event.target) && !mobileMenuToggle.contains(event.target) && leftPanel.classList.contains('active')) {
                leftPanel.classList.remove('active');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                const delay = parseInt(card.dataset.delay) || 0;
                setTimeout(() => {
                    card.classList.add('is-visible');
                }, delay);
            });

            const assetTableBody = document.getElementById('assetTableBody');
            const searchAssetInput = document.getElementById('searchAsset');
            const filterTypeSelect = document.getElementById('filterType');
            const filterStatusSelect = document.getElementById('filterStatus');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const currentPageDisplay = document.getElementById('currentPageDisplay');

            const assetsPerPage = 5;
            let currentPage = 1;
            let allAssets = []; // ตอนนี้จะเก็บข้อมูลที่ดึงมาจาก API แทนข้อมูลจำลอง
            let filteredAssets = [];

            // ฟังก์ชันสำหรับเติมตัวเลือก Type ใน Filter dropdown
            function populateTypeFilter() {
                console.log('--- populateTypeFilter() called ---'); // Debug log
                const uniqueTypes = [...new Set(allAssets.map(asset => asset.type))];
                filterTypeSelect.innerHTML = '<option value="">All Types</option>'; // เพิ่ม All Types เป็นตัวเลือกแรก
                uniqueTypes.sort().forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    filterTypeSelect.appendChild(option);
                });
                console.log('Unique Types populated:', uniqueTypes); // Debug log
            }

            // ฟังก์ชันสำหรับแสดงข้อมูลสินทรัพย์ในตาราง
            function renderAssets() {
                console.log('--- renderAssets() called ---'); // Debug log
                console.log('Current filteredAssets:', filteredAssets); // Debug log
                console.log('Current Page:', currentPage); // Debug log

                assetTableBody.innerHTML = ''; // ล้างข้อมูลเดิมในตารางก่อน
                const startIndex = (currentPage - 1) * assetsPerPage;
                const endIndex = startIndex + assetsPerPage;
                const assetsToRender = filteredAssets.slice(startIndex, endIndex); // ตัดข้อมูลตามหน้าปัจจุบัน

                console.log('Assets to Render (slice):', assetsToRender); // Debug log

                if (assetsToRender.length === 0) {
                    // ถ้าไม่มีข้อมูลตรงกับเงื่อนไข
                    assetTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px;">ไม่พบข้อมูลสินทรัพย์ที่ตรงกับเงื่อนไข</td></tr>`;
                    currentPageDisplay.textContent = 'Page 0 of 0';
                    prevPageBtn.disabled = true;
                    nextPageBtn.disabled = true;
                    console.log('No assets to render. Displaying "No data" message.'); // Debug log
                    return;
                }

                assetsToRender.forEach(asset => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${asset.asset_tag || 'N/A'}</td> 
                        <td>${asset.serial_number || 'N/A'}</td> 
                        <td>${asset.type || 'N/A'}</td>
                        <td>${asset.brand || 'N/A'}</td>
                        <td>${asset.model || 'N/A'}</td>
                        <td>${asset.status || 'N/A'}</td>
                        <td>${asset.owner || 'N/A'}</td>
                        <td>${asset.location || 'N/A'}</td>
                        <td class="action-column">
                            <button class="action-btn edit" data-id="${asset.asset_id}"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
                            <button class="action-btn delete" data-id="${asset.asset_id}"><i class="fa-solid fa-trash-can"></i> Delete</button>
                        </td>
                    `;
                    assetTableBody.appendChild(row);
                });

                updatePaginationControls(); // อัปเดตปุ่ม Pagination
                console.log('Assets rendered successfully.'); // Debug log
            }

            // ฟังก์ชันสำหรับ Apply Filters
            function applyFilters() {
                console.log('--- applyFilters() called ---'); // Debug log
                const searchTerm = searchAssetInput.value.toLowerCase();
                const selectedType = filterTypeSelect.value;
                const selectedStatus = filterStatusSelect.value;

                console.log(`Filters - Search: "${searchTerm}", Type: "${selectedType}", Status: "${selectedStatus}"`); // Debug log

                // กรองข้อมูลจาก allAssets
                filteredAssets = allAssets.filter(asset => {
                    const matchesSearch = searchTerm === '' ||
                        (asset.asset_tag && asset.asset_tag.toLowerCase().includes(searchTerm)) ||
                        (asset.serial_number && asset.serial_number.toLowerCase().includes(searchTerm));
                    const matchesType = selectedType === '' || asset.type === selectedType;
                    const matchesStatus = selectedStatus === '' || asset.status === selectedStatus;
                    return matchesSearch && matchesType && matchesStatus;
                });

                console.log('Filtered Assets (after filter logic):', filteredAssets); // Debug log
                currentPage = 1; // รีเซ็ตไปหน้าแรกเมื่อมีการกรอง
                renderAssets();
            }

            // ฟังก์ชันสำหรับ Clear Filters
            function clearFilters() {
                console.log('--- clearFilters() called ---'); // Debug log
                searchAssetInput.value = '';
                filterTypeSelect.value = '';
                filterStatusSelect.value = '';
                applyFilters(); // เรียก applyFilters อีกครั้งเพื่อแสดงข้อมูลทั้งหมด
            }

            // ฟังก์ชันสำหรับอัปเดตการควบคุม Pagination
            function updatePaginationControls() {
                console.log('--- updatePaginationControls() called ---'); // Debug log
                const totalPages = Math.ceil(filteredAssets.length / assetsPerPage);
                currentPageDisplay.textContent = `Page ${totalPages > 0 ? currentPage : 0} of ${totalPages}`;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
                console.log(`Pagination: Page ${currentPage} of ${totalPages}. Prev Disabled: ${prevPageBtn.disabled}, Next Disabled: ${nextPageBtn.disabled}`); // Debug log
            }

            // ** ฟังก์ชันสำหรับแสดง Popup แก้ไขสินทรัพย์ **
            async function showEditAssetPopup(assetId) {
                let assetData = null;
                // พยายามหาข้อมูลจาก allAssets ก่อน เพื่อลดการเรียก API
                assetData = allAssets.find(asset => asset.asset_id == assetId);

                if (!assetData) {
                    // ถ้าหาไม่เจอใน allAssets (อาจจะเพิ่งเพิ่ม หรือข้อมูลเก่า) ให้เรียก API ดึงข้อมูล
                    try {
                        const response = await fetch(`api/get_asset_by_id.php?asset_id=${assetId}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const result = await response.json();
                        if (result.success) {
                            assetData = result.data;
                        } else {
                            Swal.fire('ข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลสินทรัพย์สำหรับแก้ไขได้: ' + result.message, 'error');
                            return;
                        }
                    } catch (error) {
                        Swal.fire('ข้อผิดพลาด', 'ข้อผิดพลาดเครือข่ายในการดึงข้อมูลสินทรัพย์: ' + error.message, 'error');
                        return;
                    }
                }

                if (!assetData) {
                    Swal.fire('ข้อผิดพลาด', 'ไม่พบข้อมูลสินทรัพย์ที่ต้องการแก้ไข', 'error');
                    return;
                }

                // สร้าง HTML สำหรับฟอร์มใน Popup
                const formHtml = `
                    <form id="editAssetForm">
                        <input type="hidden" id="edit-asset-id" value="${assetData.asset_id}">
                        <div class="form-group">
                            <label for="edit-asset-tag">Asset Code:</label>
                            <input type="text" id="edit-asset-tag" value="${assetData.asset_tag || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-serial-number">Serial Number:</label>
                            <input type="text" id="edit-serial-number" value="${assetData.serial_number || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-type">Type:</label>
                            <input type="text" id="edit-type" value="${assetData.type || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-brand">Brand:</label>
                            <input type="text" id="edit-brand" value="${assetData.brand || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-model">Model:</label>
                            <input type="text" id="edit-model" value="${assetData.model || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-status">Status:</label>
                            <select id="edit-status" required>
                                <option value="In Use" ${assetData.status === 'In Use' ? 'selected' : ''}>In Use</option>
                                <option value="Ready" ${assetData.status === 'Ready' ? 'selected' : ''}>Ready</option>
                                <option value="In Repair" ${assetData.status === 'In Repair' ? 'selected' : ''}>In Repair</option>
                                <option value="Retired" ${assetData.status === 'Retired' ? 'selected' : ''}>Retired</option>
                                <option value="Broken" ${assetData.status === 'Broken' ? 'selected' : ''}>Broken</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-owner">Owner:</label>
                            <input type="text" id="edit-owner" value="${assetData.owner || ''}">
                        </div>
                        <div class="form-group">
                            <label for="edit-location">Location:</label>
                            <input type="text" id="edit-location" value="${assetData.location || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-purchase-date">Purchase Date:</label>
                            <input type="date" id="edit-purchase-date" value="${assetData.purchase_date || ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-warranty-end-date">Warranty End Date:</label>
                            <input type="date" id="edit-warranty-end-date" value="${assetData.warranty_end_date || ''}">
                        </div>
                        <div class="form-group">
                            <label for="edit-notes">Notes:</label>
                            <textarea id="edit-notes">${assetData.notes || ''}</textarea>
                        </div>
                    </form>
                `;

                const { value: formValues } = await Swal.fire({
                    title: 'แก้ไขข้อมูลสินทรัพย์',
                    html: formHtml,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'บันทึกการเปลี่ยนแปลง',
                    cancelButtonText: 'ยกเลิก',
                    didOpen: () => {
                        // ตั้งค่า CSS ให้ SweetAlert2 ตรงกับที่เราต้องการ
                        const popup = Swal.getPopup();
                        if (popup) {
                            popup.style.maxWidth = '600px'; // หรือตามขนาดที่เหมาะสม
                        }
                    },
                    preConfirm: () => {
                        const asset_id = document.getElementById('edit-asset-id').value;
                        const asset_tag = document.getElementById('edit-asset-tag').value;
                        const serial_number = document.getElementById('edit-serial-number').value;
                        const type = document.getElementById('edit-type').value;
                        const brand = document.getElementById('edit-brand').value;
                        const model = document.getElementById('edit-model').value;
                        const status = document.getElementById('edit-status').value;
                        const owner = document.getElementById('edit-owner').value;
                        const location = document.getElementById('edit-location').value;
                        const purchase_date = document.getElementById('edit-purchase-date').value;
                        const warranty_end_date = document.getElementById('edit-warranty-end-date').value;
                        const notes = document.getElementById('edit-notes').value;

                        console.log('--- Values from edit form ---');
                        console.log('asset_id:', asset_id);
                        console.log('asset_tag:', asset_tag);
                        console.log('serial_number:', serial_number);
                        console.log('type:', type);
                        console.log('brand:', brand);
                        console.log('model:', model);
                        console.log('status:', status);
                        console.log('owner:', owner);
                        console.log('location:', location);
                        console.log('purchase_date:', purchase_date);
                        console.log('warranty_end_date:', warranty_end_date);
                        console.log('notes:', notes);
                        console.log('----------------------------');

                        // ตรวจสอบข้อมูลเบื้องต้น
                        if (!asset_tag || !serial_number || !type || !brand || !model || !status || !location || !purchase_date) {
                            Swal.showValidationMessage('กรุณากรอกข้อมูลที่จำเป็นทั้งหมด');
                            return false;
                        }
                        // ... ส่วนที่เหลือ
                    }
                });

                if (formValues) {
                    // ผู้ใช้กด "บันทึกการเปลี่ยนแปลง" และข้อมูลผ่านการตรวจสอบ
                    try {
                        const response = await fetch('api/test_post_input.php', { // เปลี่ยนตรงนี้
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        })

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                        }

                        const result = await response.json();

                        if (result.success) {
                            Swal.fire('สำเร็จ!', result.message, 'success');
                            await fetchAssets(); // โหลดข้อมูลใหม่เพื่ออัปเดตตาราง
                        } else {
                            Swal.fire('ข้อผิดพลาด', result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Error updating asset:', error);
                        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถอัปเดตข้อมูลสินทรัพย์ได้: ' + error.message, 'error');
                    }
                }
            }


            // ** ฟังก์ชันใหม่: ดึงข้อมูลสินทรัพย์จาก Backend **
            async function fetchAssets() {
                console.log('--- fetchAssets() called ---'); // Debug log
                assetTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูลสินทรัพย์...</td></tr>`;
                try {
                    const response = await fetch('api/get_assets.php');
                    console.log('API Response object:', response); // Debug log

                    // ตรวจสอบว่า response.ok (HTTP status 2xx) ก่อนพยายามแปลงเป็น JSON
                    if (!response.ok) {
                        const errorText = await response.text(); // อ่านข้อความ error จาก response
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    const data = await response.json(); // แปลง response เป็น JSON
                    console.log('Parsed JSON data:', data); // Debug log

                    if (data.success) {
                        allAssets = data.data; // เก็บข้อมูลทั้งหมดที่ดึงมา
                        console.log('All Assets after fetch:', allAssets); // Debug log
                        populateTypeFilter(); // เติมตัวเลือก Type จากข้อมูลที่ได้
                        applyFilters(); // เรียก Apply Filters เพื่อแสดงผลข้อมูลเริ่มต้น
                    } else {
                        // หาก API แจ้งว่าไม่สำเร็จ
                        assetTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: red;">ข้อผิดพลาดในการโหลดสินทรัพย์: ${data.message}</td></tr>`;
                        console.error('ข้อผิดพลาดในการดึงข้อมูลสินทรัพย์ (API response indicates error):', data.message);
                        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถโหลดสินทรัพย์ได้: ' + data.message, 'error');
                    }
                } catch (error) {
                    // หากเกิดข้อผิดพลาดเครือข่ายหรือเซิร์ฟเวอร์ไม่ตอบสนอง หรือแปลง JSON ไม่ได้
                    assetTableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: red;">ข้อผิดพลาดเครือข่ายหรือเซิร์ฟเวอร์ไม่พร้อมใช้งาน</td></tr>`;
                    console.error('ข้อผิดพลาดเครือข่ายหรือเซิร์ฟเวอร์ (fetch failed):', error); // Debug log
                    Swal.fire('ข้อผิดพลาด', 'ข้อผิดพลาดเครือข่ายหรือเซิร์ฟเวอร์ไม่พร้อมใช้งาน กรุณาลองใหม่ภายหลัง', 'error');
                }
            }


            // Event Listeners สำหรับปุ่ม Filter และ Pagination
            applyFiltersBtn.addEventListener('click', applyFilters);
            clearFiltersBtn.addEventListener('click', clearFilters);

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderAssets();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredAssets.length / assetsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderAssets();
                }
            });

            // Event Listener สำหรับปุ่ม Edit และ Delete โดยใช้ Event Delegation
            assetTableBody.addEventListener('click', async (event) => {
                // ตรวจสอบว่าคลิกที่ปุ่ม 'edit' โดยตรง หรือคลิกที่ไอคอนภายในปุ่ม 'edit'
                if (event.target.classList.contains('edit') || event.target.closest('.edit')) {
                    const editButton = event.target.classList.contains('edit') ? event.target : event.target.closest('.edit');
                    const assetId = editButton.dataset.id;
                    console.log('Edit button clicked for asset_id:', assetId);
                    await showEditAssetPopup(assetId);
                } else if (event.target.classList.contains('delete') || event.target.closest('.delete')) {
                    const deleteButton = event.target.classList.contains('delete') ? event.target : event.target.closest('.delete');
                    const assetId = deleteButton.dataset.id;
                    console.log('Delete button clicked for asset_id:', assetId);
                    // await confirmDeleteAsset(assetId); // ฟังก์ชันนี้ยังไม่ได้สร้าง
                }
            });


            // Logout Function (ปรับปรุงให้ใช้ SweetAlert2)
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', () => {
                Swal.fire({
                    title: 'คุณแน่ใจหรือไม่ว่าต้องการออกจากระบบ?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'ใช่, ออกจากระบบ!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem('user'); // ลบข้อมูลผู้ใช้
                        localStorage.removeItem('token'); // ลบ token (ถ้ามี)
                        Swal.fire({
                            title: 'ออกจากระบบแล้ว!',
                            text: 'คุณออกจากระบบเรียบร้อยแล้ว.',
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            window.location.href = 'login.html'; // ส่งกลับไปหน้า Login
                        });
                    }
                });
            });

            // การแสดงข้อมูลผู้ใช้และการจัดการสิทธิ์ (User Role Management)
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userDisplayTop = document.querySelector('.main-content-header .user-display-top span');
            const memberLinkWrapperLeftPanel = document.getElementById('memberLinkWrapperLeftPanel');
            const historyLinkWrapperLeftPanel = document.getElementById('historyLinkWrapperLeftPanel');

            // ตรวจสอบว่ามีข้อมูลผู้ใช้ใน localStorage หรือไม่
            const currentUserString = localStorage.getItem('user');
            if (currentUserString) {
                try {
                    const currentUser = JSON.parse(currentUserString);
                    if (currentUser && currentUser.username) {
                        userNameDisplay.textContent = currentUser.username;
                        userDisplayTop.textContent = currentUser.username;

                        // ซ่อน/แสดงลิงก์ตาม Role
                        if (currentUser.role === 'User') {
                            if (memberLinkWrapperLeftPanel) memberLinkWrapperLeftPanel.style.display = 'none';
                            if (historyLinkWrapperLeftPanel) historyLinkWrapperLeftPanel.style.display = 'none';
                        } else if (currentUser.role === 'Admin') {
                            // ตรวจสอบให้แน่ใจว่าแสดงผล ถ้าผู้ใช้เป็น Admin
                            if (memberLinkWrapperLeftPanel) memberLinkWrapperLeftPanel.style.display = 'list-item';
                            if (historyLinkWrapperLeftPanel) historyLinkWrapperLeftPanel.style.display = 'list-item';
                        }
                    } else {
                        // หากข้อมูลผู้ใช้ไม่สมบูรณ์ หรือไม่มี username
                        console.warn('User data in localStorage is incomplete or invalid. Redirecting to login.');
                        Swal.fire({
                            icon: 'warning',
                            title: 'เซสชันหมดอายุ',
                            text: 'กรุณาเข้าสู่ระบบอีกครั้ง.',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            window.location.href = 'login.html';
                        });
                    }
                } catch (e) {
                    // หาก localStorage.getItem('user') ไม่ใช่ JSON ที่ถูกต้อง
                    console.error('Error parsing user data from localStorage:', e);
                    Swal.fire({
                        icon: 'warning',
                        title: 'เซสชันหมดอายุ',
                        text: 'ข้อมูลผู้ใช้เสียหาย กรุณาเข้าสู่ระบบอีกครั้ง.',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.href = 'login.html';
                    });
                }
            } else {
                // ถ้าไม่มีข้อมูลผู้ใช้ ให้ redirect ไปหน้า Login
                console.warn('No user data found in localStorage. Redirecting to login.');
                Swal.fire({
                    icon: 'warning',
                    title: 'เซสชันหมดอายุ',
                    text: 'กรุณาเข้าสู่ระบบอีกครั้ง.',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    window.location.href = 'login.html';
                });
            }

            // เรียกใช้ฟังก์ชัน fetchAssets() เมื่อหน้าเว็บโหลดเสร็จครั้งแรก
            fetchAssets();
        });
    </script>
</body>

</html>